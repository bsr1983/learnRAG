# RAG 系统架构文档

## 系统架构图

```
┌─────────────────────────────────────────────────────────────┐
│                     用户查询 (Query)                         │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│             查询改写 (Query Rewriting)                       │
│         - RAG-Fusion: 多查询生成                             │
│         - LLM 查询改写                                      │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│             向量检索 (Vector Retrieval)                       │
│         - Embedding Model (bge-large-zh)                    │
│         - Vector Store (Qdrant)                             │
│         - Top-K 检索                                         │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│             结果重排 (Reranking)                              │
│         - Reranker Model (bge-reranker-base)                │
│         - Cross-encoder 精排                                │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│             上下文构建 (Context Building)                     │
│         - 文档拼接                                           │
│         - Prompt 构建                                        │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│             答案生成 (Answer Generation)                     │
│         - LLM (GPT-3.5/GPT-4)                               │
│         - 结构化输出 (DSPy/Guidance)                         │
└────────────────────┬────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────────┐
│                     最终答案 (Answer)                         │
└─────────────────────────────────────────────────────────────┘
```

## 核心组件

### 1. 嵌入层 (Embedding Layer)
- **模型**: bge-large-zh / m3e-large
- **功能**: 将文本转换为向量表示
- **输出**: 1024 维向量（bge-large-zh）

### 2. 向量存储 (Vector Store)
- **数据库**: Qdrant
- **索引算法**: HNSW
- **功能**: 高效存储和检索向量

### 3. 检索层 (Retrieval Layer)
- **基础检索**: 向量相似度搜索
- **RAG-Fusion**: 多查询融合检索
- **重排**: Cross-encoder 精排

### 4. 生成层 (Generation Layer)
- **LLM**: OpenAI GPT-3.5/GPT-4
- **结构化输出**: DSPy / Guidance
- **Prompt 工程**: 上下文拼接和提示词优化

### 5. 评测层 (Evaluation Layer)
- **Ragas**: 自动化评测指标
- **ChatArena**: 对话质量评测
- **自定义指标**: 领域特定评测

## 数据流

1. **文档入库流程**:
   ```
   原始文档 → 文档分块 → 向量化 → 存储到 Qdrant
   ```

2. **查询流程**:
   ```
   用户查询 → 查询改写 → 向量检索 → 结果重排 → 上下文构建 → LLM 生成 → 结构化输出
   ```

3. **评测流程**:
   ```
   测试数据集 → Ragas 评测 → 指标计算 → 性能报告
   ```

## 技术栈

- **Python**: 3.9+
- **嵌入模型**: Sentence Transformers
- **向量数据库**: Qdrant
- **RAG 框架**: LangChain
- **结构化输出**: DSPy, Guidance
- **评测工具**: Ragas, ChatArena
- **LLM API**: OpenAI, Anthropic

## 性能优化

### 检索优化
- 使用 HNSW 索引加速检索
- RAG-Fusion 提升召回率
- 重排模型提升精确度

### 生成优化
- Prompt 工程优化
- 上下文长度控制
- 结构化输出约束

### 系统优化
- 批量处理
- 缓存机制
- 异步处理

## 扩展方向

1. **多模态 RAG**: 支持图像、视频检索
2. **实时更新**: 增量索引更新
3. **分布式部署**: 多节点向量库
4. **个性化**: 用户偏好学习
5. **多语言支持**: 跨语言检索

